<!doctype html>
<html lang="en">
  <head>
    <title>MP3 Player</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <style>

HTML {
    font-size: 62.5%; /* 1 rem == 10px */
}

BODY {
    font-family: "Raleway", "HelveticaNeue", "Helvetica Neue", Helvetica, Arial, sans-serif;
    font-size: 1.5em;
    line-height: 1.6;
    color:#222;        
    margin:0;
}

UL, OL {
    margin-top: 0;
    padding-left: 0;
}

BUTTON, .upload-button {
    display: inline-block;
    padding: 0rem 1rem;
    color: #555;
    text-align: center;
    font-size: 1.1rem;
    font-weight: 600;
    letter-spacing: .1rem;
    line-height:3rem;
    text-transform: uppercase;
    text-decoration: none;
    white-space: nowrap;
    border-radius: 4px;
    border: 1px solid #bbb;
    cursor: pointer;
    box-sizing: border-box;
    margin-right: 0.5rem;
}

.red {
    background-color:#dc3545;
    color:#fff;
    border-color: #800;
}

.orange {
    background-color:#fd7e14;
    color:#000;    
    border-color:#840;
}

.green {
    background-color:#198754;
    color:#fff;
    border-color: #080;
}

.blue {
    background-color:#0d6efd;
    color:#fff;
    border-color:#008;
}

.yellow {
    background-color:#ffc107;
    border-color: #860;
}

.cyan {
    background-color:#0dcaf0;
    border-color:#068;
}

.pink {
    background-color:#d63384;
}

.purple {
    background-color:#6f42c1;
}

INPUT {
    height: 3rem;
    padding: 6px 10px; /* The 6px vertically centers text on FF, ignored by Webkit */
    background-color: #fff;
    border: 1px solid #D1D1D1;
    border-radius: 4px;
    box-shadow: none;
    box-sizing: border-box; 
}

INPUT.red { border: 1px solid #dc3545; }

FORM > LABEL {
    font-weight: bold;
}

.container, .panel > FORM {
    clear:both;
    position: relative;
    width: 100%;
    max-width:960px;
    margin: 0 auto;
    padding: 0 5px;
    box-sizing: border-box;
    display:flex;
    flex-wrap:wrap;
    justify-content:space-between;
    align-items:center;
}

.container > DIV {
    margin: 0.3rem 0;
}

.one    { width: 100%; }
.two    { width: 100%; }
.three  { width: 100%; }
.four   { width: 100%; }
.five   { width: 100%; }
.six    { width: 100%; }
.seven  { width: 100%; }
.eight  { width: 100%; }
.nine   { width: 100%; }
.ten    { width: 100%; }
.eleven { width: 100%; }
.twelve { width: 100%; }

.panel > FORM > LABEL {
    display: block;
    width: 100%;
    margin: 0.3rem 0;
}        
.panel > FORM > DIV {
    width: 100%;
    margin: 0.3rem 0;
    clear:both;
}

@media(min-width:550px) {
    .one    { width: 4.66666666667%; }
    .two    { width: 13.3333333333%; }
    .three  { width: 22%; }
    .four   { width: 30.6666666667%; }
    .five   { width: 39.3333333333%; }
    .six    { width: 48%; }
    .seven  { width: 56.6666666667%; }
    .eight  { width: 65.3333333333%; }
    .nine   { width: 74.0%; }
    .ten    { width: 82.6666666667%; }
    .eleven { width: 91.3333333333%; }
    .twelve { width: 100%; }
    .container > .right {
        text-align : right;
    }

    .panel > FORM > LABEL {
        display: block;
        width: 22%;
        text-align:right;
        margin: 0.3rem 0;

    }        
    .panel > FORM > DIV {
        width: 74%;
        margin: 0.3rem 0;
        clear:both;
    }
}

NAV {
    display:block;
    width:100%;
    background-color:#222;
}

.navbar {
    display:block;
    width:100%;
    max-width:960px;
    align-items:center;
    display:flex;
    margin: 0 auto;
    flex-wrap:wrap;
}

.navbar > .brand {
    color:#ccc;
    flex-shrink: 0;
    width:100%;
    padding:1rem;
}

.navbar > A {
    display:inline-block;
    color:#fff;
    text-transform:uppercase;
    border-top:0.5rem solid transparent;
    border-bottom:0.5rem solid transparent;
    padding:1rem;
    flex-shrink: 0;
}

.navbar > A.selected {
    border-bottom:0.5rem solid #fff;

}

.navbar > A:hover {
    border-bottom:0.5rem solid #c0c0ff;

}

.notifications {
    background-color:#fff;
    padding:0.5rem;
}

.notification {
    width:100%;
    max-width:960px;
    margin: 0 auto;
    border-width: 1px;
    border-style: solid;
    padding:0.5rem;
    border-radius:5px;    
    margin-top:5px;
}

.notification > BUTTON {
    font-size: 0.7rem;
    padding: 0.1rem 0.5rem;
    line-height: 2rem;
    position:relative;
    float:right;
}

#modal {
    position: absolute;
    width : 100%;
    height: 100%;
    z-index: 999;
    display: none;
    justify-content:space-between;
    align-items:center;  
}

.blurred {
    filter: blur(5px);
}

#modal > .notification {
    width : 100%;
    margin: auto;
    text-align: center;
    padding-bottom: 3rem;
}

.spacer {
    visibility: hidden;
}

.hidden {
    display : none;
}

@media (min-width: 750px) {
    NAV {
        position: fixed;
        top: 0px;
        width: 100%;
        z-index: 100;
    }
    .navbar.spacer {
        height: 6rem;
    }
    .navbar > .brand {
        width:unset;
    }

    .modal > .notification {
        width : 50%;
    }
}

.panel {
    border:1px solid #aaa;
    border-radius: 4px;
    margin-top: 10px;
}

.header {
    background-color:#ccc;
    padding:0.5rem 1rem; 
}

.panel > .header {
    display:flex;
    justify-content:space-between;
    align-items:center;
    flex-basis: 100%;
}

.panel > .header > H3 {
    font-size: 2rem;
    margin: auto 0;
}

.panel > .header > .buttons {
    margin: auto 0;
    display:inline-block;
}

.buttons > BUTTON {
    margin: auto 0;
    padding: 0 1rem;
}

.even-row {
    background-color: #eee;
}

    </style>

    <script>

/** Returns element of given id. 
 */
function e(ident) {
    return document.getElementById(ident);
}

function element(kind, options) {
    let result = document.createElement(kind);
    if (options != undefined)
        for (let key in options) {
            if (key == "class") {
                for (const cls of options[key].split(" "))
                    result.classList.add(cls);
            } else {
                result[key] = options[key];
            }
        }
    return result;
}

function A(options) { return element("a", options); }
function BUTTON(options) { return element("button", options); }
function DIV(options) { return element("div", options); }
function FORM(options) { return element("form", options); }
function H1(options) { return element("h1", options); }
function LABEL(options) { return element("label", options); }
function INPUT(options) { return element("input", options); }
function P(options) { return element("p", options); }

function notification(text, color, timeout) {
    let nbar = e("notifications");
    let nbarSpacer = e("notifications-spacer");
    let npanel = DIV({ class : `notification ${color}`});
    let npanelSpacer = DIV({ class : `notification ${color}`});
    npanel.append(text);
    npanelSpacer.append(text);
    let close = (event) => {
        if (npanel.removed == undefined) {
            nbarSpacer.removeChild(npanelSpacer);
            nbar.removeChild(npanel);
            npanel.removed = true;
        }
        if (event)
            event.preventDefault();
    }
    npanel.appendChild(BUTTON({ class: color, innerText: "close", onclick : close}));
    nbar.appendChild(npanel);
    nbarSpacer.appendChild(npanelSpacer);
    if (timeout == undefined)
        timeout = 10000;
    if (timeout != 0)
        setTimeout(close, 10000);
}

function showModal(heading, text, color) {
    e("contents").classList.add("blurred");
    e("modal").style.display = "flex";
    let d = DIV({ class : `notification ${color}`});
    d.appendChild(H1({ innerText : heading }));
    d.appendChild(P({ innerHTML : text }));
    e("modal").appendChild(d);
}

function clearModal() {
    e("contents").classList.remove("blurred");
    e("modal").innerHTML = "";
    e("modal").style.display = "none";
}

/** Comms
 */

 /** Returns json obtained from given url. 
 */
async function getJSON(url) {
    return new Promise(resolve => {
        showModal("Requesting...", "Please wait, this might take a while...", "blue");
        let req = new XMLHttpRequest();
        req.open("GET", url);
        req.setRequestHeader("Accept", "application/json");
        req.onreadystatechange = function () {
            if (this.readyState == 4) {
                if (this.status == 200) {
                    resolve(JSON.parse(this.responseText));
                    // don't notify, we only use this for status...
                    //notification("Request successful", "green");
                } else {
                    resolve(undefined);
                    notification(`Request for ${url} failed.`, "red");
                }
                clearModal();
            }
        }
        req.send();
    })
}

async function downloadFile(path) {
    return new Promise(resolve => {
        showModal("Requesting...", "Please wait, this might take a while...", "blue");
        let req = new XMLHttpRequest();
        // TODO this is only for local checks
        req.open("GET", path);
        //req.open("GET", `sd?path=${path}`);
        req.onreadystatechange = function () {
            if (this.readyState == 4) {
                if (this.status == 200) {
                    resolve(this.responseText);
                    // no need to notify really
                    //notification("Request successful", "green", 1000);
                } else {
                    resolve(undefined);
                    notification(`Request for ${path} failed.`, "red");
                }
                clearModal();
            }
        }
        req.send();
    });
}

async function downloadJSON(path) {
    let result = await downloadFile(path);
    if (result)
        return JSON.parse(result);
    else 
        return undefined;
}

async function uploadFileContents(path, contents, mime = "text/plain") {
    return new Promise(resolve => {
        showModal("Uploading...", "Please wait, this might take a while...", "blue");
        let fd = new FormData();
        let blob = new Blob([contents], { type : mime});
        fd.append("path", path);
        fd.append("filename", blob, path);
        let req = new XMLHttpRequest();
        req.open("POST", "sdUpload", true);
        req.onreadystatechange = function () {
            if (this.readyState == 4) {
                if (this.status == 200) {
                    resolve(true);
                    notification("Upload successful", "green", 1000);
                } else {
                    resolve(undefined);
                    notification(`Upload for ${path} failed.`, "red");
                }
                clearModal();
            }
        }
        req.send(fd);    
    });
}

async function uploadFile(path, file) {
    return new Promise(resolve => {
        showModal("Uploading...", "Please wait, this will take a while...", "blue");
        let fd = new FormData();
        fd.append("path", path);
        fd.append("filename", file.files[0]);
        let req = new XMLHttpRequest();
        req.open("POST", "sdUpload", true);
        req.onreadystatechange = function () {
            if (this.readyState == 4) {
                if (this.status == 200) {
                    resolve(true);
                    notification("Upload successful", "green", 1000);
                } else {
                    resolve(undefined);
                    notification(`Upload for ${path} failed.`, "red");
                }
                clearModal();
            }
        }
        req.send(fd);    
    });
}

/* Helper functions 
 */

async function openDir(panel, path, title, allowEdit) {
    // TODO this is only for checking locally
    let json = await getJSON("sdls");
    //let json = await getJSON(`sdls?path=${path}`); 
    e(`${panel}-title`).innerText = title;
    let table = e(`${panel}-table`);
    table.innerHTML = "";
    let i = 0;
    for (const entry of json) {
        let row = DIV({ class : "container" });
        let l = LABEL({ class : "three" });
        let a = A({ innerText : entry["name"] });
        l.appendChild(a);
        if (entry["size"] == "dir") {
            // TODO onclick opens the folder in the same panel
        } else {
            a.href = `sd?path=${path}/${entry["name"]}`;
        }
        row.appendChild(l);
        {
            let d = DIV({ class : "three" });
            d.append(entry["size"]);
            row.appendChild(d);
        }
        {
            let d = DIV({ class : "three" });
            let btnDelete = BUTTON({ class : "red", innerText : "Delete" });
            d.appendChild(btnDelete);
            if (allowEdit && entry["size"] != "dir" && entry["name"].endsWith(".txt")) {
                let btnEdit = BUTTON({ class : "orange", innerText : "Edit"});
                d.appendChild(btnEdit);
            }
            row.appendChild(d);
        }
        ++i;
        if (i % 2 == 0)
            row.classList.add("even-row");
        table.appendChild(row);
    }
    {
        let row = DIV({class : "container header" });
        let l = LABEL({innerText : "Upload file: ", class : "three"});
        row.appendChild(l);
        let fname = INPUT({class : "three", type : "text" });
        row.appendChild(fname);
        let d = DIV({ class : "three" });
        let file = INPUT({ type: "file", id :  `${panel}-upload`, name : "filename"});
        file.style.display = "none";
        let fileBtn = LABEL({ innerText: "Select File", htmlFor : file.id, class : "upload-button green" });
        let upload = BUTTON({ class : "blue", innerText: "Upload" });
        d.appendChild(file);
        d.appendChild(fileBtn);
        d.appendChild(upload);
        row.appendChild(d);
        table.appendChild(row);
        upload.onclick = async (event) => {
            event.preventDefault();
            await uploadFile(`${path}/${fname.value}`, file);
            openDir(panel, path, title);
        }
    }
    if (allowEdit) {
        let row = DIV({class : "container header" });
        let l = LABEL({innerText : "New file: ", class : "three"});
        row.appendChild(l);
        let fname = INPUT({class : "three", type : "text" });
        row.appendChild(fname);
        let d = DIV({ class : "three" });
        let editBtn = BUTTON({class: "orange", innerText: "Edit"});
        d.appendChild(editBtn);
        row.appendChild(d);
        table.appendChild(row);
    }
    e(panel).style.display = "block";
}

/* Form controls
 */
function setToggle(name, value) {
    let enabled = e(`${name}-enabled`);
    let disabled = e(`${name}-disabled`);
    if (! enabled.isSetup) {
        let f = (event) => {
            if (enabled.classList.contains("green")) {
                enabled.classList.remove("green");
                disabled.classList.add("red");
            } else {
                enabled.classList.add("green");
                disabled.classList.remove("red");
            }
            event.preventDefault();
        };
        enabled.onclick = f
        disabled.onclick = f;
        enabled.isSetup = true;
    }
    if (value) {
        enabled.classList.add("green");
        disabled.classList.remove("red");
    } else {
        enabled.classList.remove("green");
        disabled.classList.add("red");
    }
}

function getToggleValue(name) {
    let enabled = e(`${name}-enabled`);
    let disabled = e(`${name}-disabled`);
    return enabled.classList.contains("green");
}

function setOnOff(name, value) {
    let btn = e(name);
    if (!btn.isSetup) {
        btn.onclick = (event) => {
            btn.classList.toggle("green");
            event.preventDefault();
        }
        btn.isSetup = true;
    }
    if (value)
        btn.classList.add("green");
    else
        btn.classList.remove("green");
}

function getOnOffValue(name) {
    let btn = e(name);
    return btn.classList.contains("green");
}

function getAndCheckInputNumber(name, min, max) {
    let input = e(name);
    let value = Number(input.value);
    if (! isNaN(value) && (value >= min) && (value <= max)) {
        input.classList.remove("red");
        return value;
    } else {
        input.classList.add("red");
        return INVALID_DATA;
    }
}

async function getAndCheckExistingFile(name, enabled) {
    // TODO check that the file exists
    return e(name).value;
}

function checkFormValidAndSend(json, path) {
    for (let key in json) {
        if (json[key] == INVALID_DATA) {
            notification("Invalid form values detected. Please fix and then try again", "red");
            return;
        }
    }
    uploadFileContents(path, JSON.stringify(json), "text/json");
}

const SETTINGS_FILE="player/settings.json";
const ALARM_FILE="player/alarm.json";
const GREETING_FILE="player/greeting.json";
const PLAYLISTS_FILE="player/playlists.json";
const NETWORK_FILE="player/wifi.json";
const RADIO_FILE="player/radio.json";
const WT_FILE = "player/bot.json";

// invalid data marker
const INVALID_DATA = { _ : "invalid" };

async function getStatus() {
    let refresh = e("status-refresh");
    refresh.disabled = true;
    refresh.innerText = "Updating";
    let json = await getJSON("status");
    if (json != undefined) {
        e("status-battery").innerHTML = `${json["vcc"] / 100}V`;
        e("status-wifi").innerHTML = `rssi ${json["rssi"]}, ${json["ap"] ? "AP" : ""}`;
        e("status-temp").innerHTML = `${json["temp"] / 10} C`;
        e("status-system").innerHTML = `${json["mem"]} mem free, ${json["maxLoopTime"]} ms max loop time`;
        e("status-form").style.display = "flex";
    } else {
        e("status-form").style.display = "none";
        e("status-battery").innerHTML = "???";
        e("status-wifi").innerHTML = "???";
        e("status-temp").innerHTML = "???";
        e("status-system").innerHTML = "???";
    }
    refresh.innerText = "Refresh"
    refresh.disabled = false;
}

async function expand(name) {
    let form = e(`${name}-form`);
    if (! form.initialized) {
        let x = await window[`get_${name}`]();
        if (!x)
            return;
        form.initialized = true;
    }
    form.style.display = "flex";
    e(`${name}-save`).style.display = "inline";
    e(`${name}-edit`).style.display = "none";
    e(`${name}-close`).style.display = "inline";
}

function collapse(name) {
    e(`${name}-form`).style.display = "none";
    e(`${name}-save`).style.display = "none";
    e(`${name}-close`).style.display = "none";
    e(`${name}-edit`).style.display = "inline";
}

async function get_network() {
    let json = await downloadJSON(NETWORK_FILE);
    if (json) {
        e("network-ap-ssid").value = json["ap"]["ssid"];
        e("network-ap-password").value = json["ap"]["password"];
        e("network-1-ssid").value = json["networks"][0]["ssid"];
        e("network-1-password").value = json["networks"][0]["password"];
        e("network-2-ssid").value = json["networks"][1]["ssid"];
        e("network-2-password").value = json["networks"][1]["password"];
        e("network-3-ssid").value = json["networks"][2]["ssid"];
        e("network-3-password").value = json["networks"][2]["password"];
        return true;
    } else {
        return false;
    }
}

async function save_network() {
    let stuff = {
        ap : {
            ssid : e("network-ap-ssid").value,
            password : e("network-ap-password").value
        },
        networks : new Array()
    }
    for (let i = 1; i <= 3; i++) {
        networks.push({
            ssid : e(`network-${i}-ssid`).value,
            ssid : e(`network-${i}-password`).value,
        });
    }
    checkFormValidAndSend(stuff, NETWORK_FILE);
}

async function get_settings() {
    let json = await downloadJSON(SETTINGS_FILE);
    if (json) {
        e("settings-speaker-max").value = json["maxSpeakerVolume"];
        e("settings-headphones-max").value = json["maxHeadphonesVolume"];
        e("settings-brightness-max").value = json["maxBrightness"];
        setToggle("settings-radio", json["radioEnabled"]);
        setToggle("settings-disco", json["discoEnabled"]);
        setToggle("settings-lights", json["lightsEnabled"]);
        setToggle("settings-wt", json["walkieTalkieEnabled"]);
        e("settings-timezone").value = json["timezone"];
        e("settings-sync-hour").value = json["syncHour"];
        return true;
    } else {
        return false;
    }
}

async function save_settings() {
    let stuff = {
        maxSpeakerVolume : getAndCheckInputNumber("settings-speaker-max", 0, 15),
        maxHeadphonesVolume : getAndCheckInputNumber("settings-headphones-max", 0, 15),
        maxBrightness : getAndCheckInputNumber("settings-brightness-max", 0, 255),
        timezone : getAndCheckInputNumber("settings-timezone", -12, 12),
        syncHour : getAndCheckInputNumber("settings-sync-hour", 0, 23),
        radioEnabled : getToggleValue("settings-radio"),
        discoEnabled : getToggleValue("settings-disco"),
        lightsEnabled : getToggleValue("settings-lights"),
        walkieTalkieEnabled : getToggleValue("settings-wt")
    };
    checkFormValidAndSend(stuff, SETTINGS_FILE);
}

async function get_alarm() {
    let json = await downloadJSON(ALARM_FILE);
    if (json) {
        setToggle("alarm", json["enabled"]);
        e("alarm-h").value = json["h"];
        e("alarm-m").value = json["m"];
        setOnOff("alarm-mon", json["mon"]);
        setOnOff("alarm-tue", json["tue"]);
        setOnOff("alarm-wed", json["wed"]);
        setOnOff("alarm-thu", json["thu"]);
        setOnOff("alarm-fri", json["fri"]);
        setOnOff("alarm-sat", json["sat"]);
        setOnOff("alarm-sun", json["sun"]);
        e("alarm-file").value = json["file"];
        return true;
    } else {
        return false;
    }
}

async function save_alarm() {
    let stuff = {
        enabled : getToggleValue("alarm"),
        h : getAndCheckInputNumber("alarm-h", 0, 23),
        m : getAndCheckInputNumber("alarm-m", 0, 59),
        mon : getOnOffValue("alarm-mon"),
        tue : getOnOffValue("alarm-tue"),
        wed : getOnOffValue("alarm-wed"),
        thu : getOnOffValue("alarm-thu"),
        fri : getOnOffValue("alarm-fri"),
        sat : getOnOffValue("alarm-sat"),
        sun : getOnOffValue("alarm-sun"),
        file : await getAndCheckExistingFile("alarm-file", getToggleValue("alarm"))
    };
    await checkFormValidAndSend(stuff, ALARM_FILE);
    sendCommand("reload_alarm");
}

/** Greeting settings. 
 */

async function get_greeting() {
    let json = await downloadJSON(GREETING_FILE);
    if (json) {
        for (let i = 0; i <= 2; i++) {
            setToggle(`greeting-${i}`, json[i]["enabled"]);
            e(`greeting-${i}-d`).value = json[i]["d"];
            e(`greeting-${i}-m`).value = json[i]["m"];
            e(`greeting-${i}-file`).value = json[i]["file"];
        }
        return true;
    } else {
        return false;
    }
}

async function save_greeting() {
    let stuff = new Array();
    for (let i = 0; i < 3; i++) {
        let alarm = {
            enabled : getToggleValue(`greeting-${i}`),
            d : getAndCheckInputNumber(`greeting-${i}-d`, 1, 31),
            m : getAndCheckInputNumber(`greeting-${i}-m`, 1, 12),
            file : await getAndCheckExistingFile(`greeting-${i}-file`, getToggleValue(`greeting-${i}`))
        };
        stuff.push(alarm);
    }
    checkFormValidAndSend(stuff, GREETING_FILE);
}

/** MP3 Playlists
 
    List of playlists and 
 */

 async function get_playlists() {
     let json = await downloadJSON(PLAYLISTS_FILE);
     let form = e("playlists-form");
     form.innerHTML = "";
     if (json) {
        for (let i = 0; i <= 7; i++) {
            {
                let l = LABEL({ innerText : `${i + 1}`});
                form.appendChild(l);
                let d = DIV();
                let input = INPUT({ id :  `playlist-${i}`, type : "text",  value : json[i].name});
                d.appendChild(input);
                d.append(" (name)");
                form.appendChild(d);
            }
            {
                form.appendChild(LABEL());
                let d = DIV();
                let btnEnabled = BUTTON({ id : `playlist-${i}-enabled`, innerText : "Enabled"});
                let btnEdit = BUTTON({ innerText : "Edit" });
                btnEdit.innerText = "Edit";
                btnEdit.onclick = async (event) => {
                    event.preventDefault();
                    await openDir("playlist-edit", `${i + 1}`, `Playlist ${json[i].name}`);
                    e("playlists-settings").style.display = "none";
                }
                d.appendChild(btnEnabled);
                d.append(" ");
                d.appendChild(btnEdit);
                form.appendChild(d);
                setOnOff(btnEnabled.id, json[i]["enabled"]);
            }
        }
        return true;
    } else {
        return false;
    }
}

async function save_playlists() {
    let stuff = new Array();
    for (let i = 0; i < 8; i++) {
        let playlist = {
            enabled : getToggleValue(`playlist-${i}-enabled`),
            name : e(`playlist-${id}`).value
        };
        stuff.push(playlist);
    }
    checkFormValidAndSend(stuff, PLAYLISTS_FILE);
}


/** Radio settings. 
 */
async function get_radio() {
    let json = await downloadJSON(RADIO_FILE);
    if (json) {
        setToggle("radio-mono", json["forceMono"]);
        setToggle("radio-manual", json["manualTuning"]);
        for (let i = 0; i < 8; i++) {
            if (! e(`radio-freq-${i}`)) {
                let d = DIV();
                d.appendChild(INPUT({id : `radio-freq-${i}`, type : "text", size : "5"}));
                d.append(" (76.0 - 108.0 MHz), name: ");
                d.appendChild(INPUT({id : `radio-name-${i}`, type : "text" }));
                form.appendChild(LABEL());
                form.appendChild(d);
            }
            e(`radio-freq-${i}`).value = json["stations"][i]["freq"] / 10;
            e(`radio-name-${i}`).value = json["stations"][i]["name"];
        }
        return true;
    } else {
        return false;
    }
}

async function save_radio() {
    let stuff = {
        forceMono : getToggleValue("radio-mono"),
        manualTuning : getToggleValur("radio-manual"),
        stations : new Array()
    }
    for (let i = 0; i < 8; ++i) {
        stuff.stations.push({
            freq : getAndCheckInputNumber(`radio-freq-${i}`, 76, 108),
            name : e(`radio-name-${i}`).value
        })
    }
    checkFormValidAndSend(stuff, RADIO_FILE);
}

/** Walkie-talkie
 */

 async function get_wt() {
    let json = await downloadJSON(WT_FILE);
    if (json) {
        e("wt-bot-id").value = json["id"];
        e("wt-bot-token").value = json["token"];
        e("wt-admin-id").value = json["adminId"];
        e("wt-chat-id").value = json["chatId"];
        e("wt-fingerprint").value = json["fingerprint"];
        return true;
    } else {
        return false;
    }
 }

 async function save_wt() {
    let stuff = {
        id : e("wt-bot-id").value,
        token : e("wt-bot-token").value,
        adminId : e("wt-admin-id").value,
        chatId : e("wt-chat-id").value,
        fingerprint : e("wt-fingerprint").value
    };
    checkFormValidAndSend(stuff, WT_FILE);
 }


/** Extras
 */

async function sendCommand(cmd) {
    return new Promise(resolve => {
        let req = new XMLHttpRequest();
        req.open("GET", `cmd?cmd=${cmd}`);
        req.onload = function () {
            resolve(req.responseText);
        };
        // TODO error
        req.onerror = function() {
            resolve(undefined);
        }
        req.send();
    });
}

async function debugLoad() {
    let path = e("debug-file-path").value;
    let contents = await downloadFile(path);
    if (contents != undefined)
        e("debug-file-contents").value = contents;
}

async function debugStore() {
    let path = e("debug-file-path").value;
    let contents = e("debug-file-contents").value;
    uploadFileContents(path, contents);
}

/* Selects the nav item. 

   It would be nice eventually to get the possibilities from the navbar itself, and only change the relevant ones perhaps.
 */
function navSelect(name) {
    for (const x of ["settings", "playlists", "radio", "wt", "expert"]) {
        if (name == x) {
            e(`nav-${x}`).classList.add("selected");
            e(x).style.display="flex";
        } else {
            e(`nav-${x}`).classList.remove("selected");
            e(x).style.display="none";
        }
    }
    if (name == "playlists" || name == "radio" || name == "wt")
        expand(name);
}


function onLoad() {
    getStatus();   
}


    </script>
  </head>
  <body onload="onLoad()">
    <div id="modal"></div>
    <div class="navbar spacer"></div>
    <div class="notifications spacer" id="notifications-spacer"></div>
    <nav>
        <div class="navbar">
            <div class="brand">mp3-player</div>
            <a id="nav-settings" onclick="navSelect('settings')" class="selected">Settings</a>
            <a id="nav-playlists" onclick="navSelect('playlists')">Playlists</a>
            <a id="nav-radio" onclick="navSelect('radio')">Radio</a>
            <a id="nav-wt" onclick="navSelect('wt')">Walkie-Talkie</a>
            <a id="nav-expert" onclick="navSelect('expert')">Expert</a>
        </div>
        <div class="notifications" id="notifications">
        </div>       
    </nav>

<div id="contents">

    <div class="container" id="settings">
        <div class="panel twelve">
            <div class="header">
                <h3>Status</h3>
                <div class="buttons">
                    <button id="status-refresh" onclick="getStatus()">Refresh</button>
                </div>
            </div>
            <form id="status-form" style="display:none">
                <label>Battery:</label>
                <div id="status-battery">56% (3.56V) Charging</div>
                <label>WiFi:</label>
                <div id="status-wifi">rssi stuff, AP</div>
                <label>Temperature:</label>
                <div id="status-temp">27 C</div>
                <label>System:</label>
                <div id="status-system">3KB mem free, 67ms max loop time</div>        
            </form>
        </div>

        <div class="panel twelve">
            <div class="header">
                <h3>Network</h3>
                <div class="buttons">
                    <button id="network-save" class="hidden red" onclick="save_network()">Save</button>
                    <button id="network-edit" onclick="expand('network')">Edit</button>
                    <button id="network-close" class="hidden" onclick="collapse('network')">Close</button>
                </div>
            </div>
            <form id="network-form" style="display:none">
                <label>AP:</label>
                <div>
                    <input id="network-ap-ssid" type="text"> (name)
                </div>
                <label></label>
                <div>
                    <input id="network-ap-password" type="text"> (password)
                </div>
                <label>Network 1:</label>
                <div>
                    <input id="network-1-ssid" type="text"> (name)
                </div>
                <label></label>
                <div>
                    <input id="network-1-password" type="password"> (password)
                </div>
                <label>Network 2:</label>
                <div>
                    <input id="network-2-ssid" type="text"> (name)
                </div>
                <label></label>
                <div>
                    <input id="network-2-password" type="password"> (password)
                </div>
                <label>Network 3:</label>
                <div>
                    <input id="network-3-ssid" type="text"> (name)
                </div>
                <label></label>
                <div>
                    <input id="network-3-password" type="password"> (password)
                </div>
            </form>
        </div>

        <div class="panel twelve">
            <div class="header">
                <h3>Settings</h3>
                <div class="buttons">
                    <button id="settings-save" class="hidden red" onclick="save_settings()">Save</button>
                    <button id="settings-edit" onclick="expand('settings')">Edit</button>
                    <button id="settings-close" class="hidden" onclick="collapse('settings')">Close</button>
                </div>
            </div>
            <form id = "settings-form" style="display:none">
                <label>Max volume (speaker):</label>
                <div>
                    <input type="text" id="settings-speaker-max"> (0..15)
                </div>
                <label>Max volume (headphones):</label>
                <div>
                    <input type="text" id="settings-headphones-max"> (0..15)
                </div>
                <label>Max brightness:</label>
                <div>
                    <input type="text" id="settings-brightness-max"> (0..255)
                </div>
                <label>FM Radio:</label>
                <div>
                    <button id="settings-radio-enabled">Enabled</button>
                    <button id="settings-radio-disabled">Disabled</button>
                </div>
                <label>Disco:</label>
                <div>
                    <button id="settings-disco-enabled">Enabled</button>
                    <button id="settings-disco-disabled">Disabled</button>
                </div>
                <label>Light Settings:</label>
                <div>
                    <button id="settings-lights-enabled">Enabled</button>
                    <button id="settings-lights-disabled">Disabled</button>
                </div>
                <label>Walkie-Talkie:</label>
                <div>
                    <button id="settings-wt-enabled">Enabled</button>
                    <button id="settings-wt-disabled" >Disabled</button>
                </div>
                <label>Timezone:</label>
                <div>
                    <input type="text" id="settings-timezone"> (UTC offset in hours, -12, + 12)
                </div>
                <label>Sync Hour:</label>
                <div>
                    <input type="text" id="settings-sync-hour"> (0..23)
                </div>
            </form>
        </div>

        <div class="panel twelve">
            <div class="header">
                <h3>Alarm Clock</h3>
                <div class="buttons">
                    <button id="alarm-save" class="hidden red" onclick="save_alarm()">Save</button>
                    <button id="alarm-edit" onclick="expand('alarm')">Edit</button>
                    <button id="alarm-close" class="hidden" onclick="collapse('alarm')">Close</button>
                </div>
            </div>
            <form id="alarm-form" style="display:none">
                <label></label>
                <div>
                    <button id="alarm-enabled">Enabled</button>
                    <button id="alarm-disabled">Disabled</button>
                </div>
                <label>Alarm:</label>
                <div>
                    <input id="alarm-h" type="text" size=3> :
                    <input id="alarm-m" type="text" size=3> (HH : MM, 0..23, 0..60)
                </div>
                <label>Days:</label>
                <div>
                    <button id="alarm-mon">Mon</button>
                    <button id="alarm-tue">Tue</button>
                    <button id="alarm-wed">Wed</button>
                    <button id="alarm-thu">Thu</button>
                    <button id="alarm-fri">Fri</button>
                    <button id="alarm-sat">Sat</button>
                    <button id="alarm-sun">Sun</button>
                </div>
                <label>File:</label>
                <div>
                    <input type="text" id="alarm-file"> (mp3 file on SD card)
                </div>
            </form>
        </div>

        <div class="panel twelve">
            <div class="header">
                <h3>Greetings</h3>
                <div class="buttons">
                    <button id="greeting-save" class="hidden red" onclick="save_greeting()">Save</button>
                    <button id="greeting-edit" onclick="expand('greeting')">Edit</button>
                    <button id="greeting-close" class="hidden" onclick="collapse('greeting')">Close</button>
                </div>
            </div>
            <form id="greeting-form" style="display:none">
                <label>First:</label>
                <div>
                    <button id="greeting-0-enabled">Enabled</button>
                    <button id="greeting-0-disabled">Disabled</button>
                </div>
                <label></label>
                <div>
                    <input id="greeting-0-d" type="text" size=3> /
                    <input id="greeting-0-m" type="text" size=3> (DD / MM, 1..31, 1..12)
                </div>
                <label></label>
                <div>
                    <input type="text" id="greeting-0-file"> (mp3 file on SD card)
                </div>
                <label>Second:</label>
                <div>
                    <button id="greeting-1-enabled">Enabled</button>
                    <button id="greeting-1-disabled">Disabled</button>
                </div>
                <label></label>
                <div>
                    <input id="greeting-1-d" type="text" size=3> /
                    <input id="greeting-1-m" type="text" size=3> (DD / MM, 1..31, 1..12)
                </div>
                <label></label>
                <div>
                    <input type="text" id="greeting-1-file"> (mp3 file on SD card)
                </div>
                <label>Third:</label>
                <div>
                    <button id="greeting-2-enabled">Enabled</button>
                    <button id="greeting-2-disabled">Disabled</button>
                </div>
                <label></label>
                <div>
                    <input id="greeting-2-d" type="text" size=3> /
                    <input id="greeting-2-m" type="text" size=3> (DD / MM, 1..31, 1..12)
                </div>
                <label></label>
                <div>
                    <input type="text" id="greeting-2-file"> (mp3 file on SD card)
                </div>
            </form>
        </div>
    </div>

    <div class="container" id="playlists" style="display:none">
        <div class="panel twelve" id="playlists-settings">
            <div class="header">
                <h3>Playlists</h3>
                <div class="buttons">
                    <button id="playlists-save" class="hidden red" onclick="save_playlists()">Save</button>
                    <button id="playlists-edit" onclick="expand('playlists')">Edit</button>
                    <button id="playlists-close" class="hidden" onclick="collapse('playlists')">Close</button>
                </div>
            </div>
            <form id="playlists-form" style="display:none">
                <!-- autogenerated -->
            </form>
        </div>        

        <div class="panel twelve" id="playlist-edit" style="display:none">
            <div class="header">
                <h3 id="playlist-edit-title"></h3>
                <div class="buttons">
                    <button onclick="e('playlist-edit').style.display='none'; e('playlists-settings').style.display='block'">Back</button>
                </div>
            </div>
            <div id="playlist-edit-table">
            </div>
        </div>

    </div>

    <div class="container" id="radio" style="display:none">
        <div class="panel twelve" id="radio-settings">
            <div class="header">
                <h3>FM Radio</h3>
                <div class="buttons">
                    <button id="radio-save" class="hidden red" onclick="save_radio()">Save</button>
                    <button id="radio-edit" onclick="expand('radio')">Edit</button>
                    <button id="radio-close" class="hidden" onclick="collapse('radio')">Close</button>
                </div>
            </div>
            <form id="radio-form" style="display:none">
                <label>Force mono:</label>
                <div>
                    <button id="radio-mono-enabled">Enabled</button>
                    <button id="radio-mono-disabled">Disabled</button>
                </div>
                <label>Manual Tuning:</label>
                <div>
                    <button id="radio-manual-enabled">Enabled</button>
                    <button id="radio-manual-disabled">Disabled</button>
                </div>
                <label>Stations:</label>
                <div>
                    <input id="radio-freq-0" type="text" size="5"> (76.0 - 108.0 MHz), name: <input type="text" id="radio-name-0">
                </div>
            </form>
        </div>
    </div>

    <div class="container" id="wt" style="display:none">
        <div class="panel twelve" id="wt-settings">
            <div class="header">
                <h3>Walkie Talkie Settings</h3>
                <div class="buttons">
                    <button id="wt-save" class="hidden red" onclick="save_wt()">Save</button>
                    <button id="wt-edit" onclick="expand('wt')">Edit</button>
                    <button id="wt-close" class="hidden" onclick="collapse('wt')">Close</button>
                </div>
            </div>
            <form id="wt-form" style="display:none">
                <label>Bot ID:</label>
                <div>
                    <input id="wt-bot-id" type="text">
                </div>
                <label>Bot token:</label>
                <div>
                    <input id="wt-bot-token" type="text">
                </div>
                <label>Admin ID:</label>
                <div>
                    <input id="wt-admin-id" type="text">
                </div>
                <label>Chat ID:</label>
                <div>
                    <input id="wt-chat-id" type="text">
                </div>
                <label>Fingerprint:</label>
                <div>
                    <input id="wt-fingerprint" type="text">
                </div>
                <label>Certificate:</label>
                <div>
                    <button>Download</button>
                    <input style="display:none" type="file" id="wt-cert" name="wt-cert">
                    <label for="wt-cert" class="upload-button green">Select file</label>
                    <button class="red">Upload</button>
                </div>
            </form>
        </div>

    </div>

    <div class="container" id="expert" style="display:none">
        <!-- The Expert level settings-->

        <div class="panel twelve" id="expert-commands">
            <div class="header">
                <h3>Commands</h3>
            </div>
            <form>
                <label>Power:</label>
                <div>
                    <button onclick="sendCommand('sleep')">Sleep</button>
                </div>
                <label>Maintenance:</label>
                <div>
                    <button onclick="sendCommand('sync')">Sync</button>
                </div>
                <label>Troubleshooting:</label>
                <div>
                    <button onclick="sendCommand('reset')">Reset</button>
                    <button class="red" onclick="sendCommand('format')">Format</button>
                </div>
            </form>
        </div>

        <div class="panel twelve" id="expert-ls">
            <div class ="header">
                <h3 id="expert-ls-title">SD Card Contents</h3>
                <div class="buttons">
                    <button onclick="openDir('expert-ls', '/', 'SD - /', true)">Open</button>
                </div>
            </div>
            <div id="expert-ls-table">
            </div>            
        </div>

        <div class="panel twelve">
            <div class="header">
                <h3>Debug - FileEdit</h3>
                <div class="buttons">
                    <button onclick="debugLoad()">Load</button>
                    <button onclick="debugStore()" class="orange">Store</button>
                </div>
            </div>
            <form>
                <label>File:</label>
                <div>
                    <input type="text" id="debug-file-path"> (path of file to edit in server)
                </div>
                <label>Contents:</label>
                <div>
                    <textarea style="width:95%" rows="20" id="debug-file-contents"></textarea>
                </div>
            </form>
        </div>

    </div>

</div>

    <iframe name="dummyframe" id="dummyframe" style="display: none;"></iframe>
  </body>
</html>